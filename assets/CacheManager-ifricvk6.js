import{u as j,j as e,r}from"./vendor-B96ILis_.js";import{g as B,a as N,c as k,b as E,d as Q,e as V,f as T,h as X,i as v,P as Y,j as Z}from"./index-Brq-ZZ2L.js";import"./react-dom-SpT7pyI8.js";import"./i18n-en-BTz_pYLY.js";function _(a){return new Worker("/poke-corpus/assets/cacheManagerWorker-B6H5lA-9.js",{name:a?.name})}function K({callback:a}){const{t}=j();return e.jsx("button",{className:"link",title:t("delete"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function ee({callback:a}){const{t}=j();return e.jsx("button",{className:"link",title:t("refresh"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function se({cacheStorageEnabled:a,cachedFileInfo:t}){const{t:s}=j(),l=r.useMemo(()=>v(t.map(([,x])=>x).reduce((x,u)=>x+u,0)),[t]);return e.jsxs("ul",{children:[e.jsx("li",{children:s("cache.storageStatus",{val:s(a?"cache.storageEnabled":"cache.storageDisabled")})}),a&&e.jsx("li",{children:s("cache.filesStored",{count:t.length})}),a&&e.jsx("li",{children:s("cache.storageUsed",l)})]})}function ae({loadedBytes:a,totalBytes:t,progress:s}){const{t:l}=j();return e.jsxs("div",{className:"cache-entry-notice",children:[l("cache.loading",{message:l("cache.inProgress"),loaded:l("cache.size",v(a)),total:l("cache.size",v(t))}),e.jsx(Y,{progress:s})]})}function ce({cachedFileInfo:a,cacheCollections:t,clearCachedFile:s}){const{t:l}=j(),x=r.useMemo(()=>Object.entries(k.collections).map(([m])=>{const w=a.filter(([[i]])=>m===i);return[m,w.map(([,i])=>i).reduce((i,M)=>i+M,0),w.every(([,,i])=>i===!0)]}).filter(([,m])=>m>0),[a]);return e.jsx("div",{className:"cache-entry-list",children:a.length>0&&x.map(([u,m,w],i)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:l(`collections:${u}.name`),children:l(`collections:${u}.short`)})}),e.jsx("div",{children:l("cache.size",v(m))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(ee,{callback:()=>t(u)}),e.jsx(K,{callback:()=>s(u)})]})]},i))})}function ie({active:a,showModal:t}){const{t:s}=j(),[l,x]=r.useTransition(),[u,m]=r.useState(!1),[w,i]=r.useState([]),[M,P]=r.useState(!1),[z,F]=r.useState(0),[I,D]=r.useState(0),[L,W]=r.useState(0),g=r.useRef(null),S=async()=>{m("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},O=n=>{const[o,d,f,b]=n.data;F(d/f),D(d),W(f),o!=="loading"&&(o==="done"?console.log("Caching complete"):o==="error"&&console.error("Caching error"),g.current?.terminate(),g.current=null,C(b),P(!1))},A=(n=null)=>{"caches"in window&&(P(!0),F(0),D(0),g.current===null&&(console.log("Creating new worker..."),g.current=new _,g.current.addEventListener("message",O),g.current.postMessage(n)))},C=async n=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const o=await B(),d=await N(),f=Object.entries(k.collections).flatMap(([c,h])=>h.files.flatMap(p=>h.languages.map(J=>[c,J,p]))),b=f.map(([c,h,p])=>E(c,h,p)),y=await Promise.all(b.map(c=>Q(o,d,c).then(async([h,p])=>[h!==void 0?(await h.blob()).size:-1,p])));i(y.map(([c,h],p)=>[f[p],c,h]).filter(([,c])=>c!==-1));const G=new Set(b);(await V()).filter(c=>!G.has(c)).forEach(c=>{console.debug(`Deleted ${c} from cache`),o.delete(c),T(d,c)}),d.close(),n===null&&y.some(([c,h])=>c===-1||!h)&&H()}},R=async()=>{g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(o=>o.unregister());const n=[];if("indexedDB"in window&&"databases"in window.indexedDB&&n.push(Z().then(()=>C())),"caches"in window){const o=await B();n.push(o.keys().then(d=>Promise.all(d.map(f=>o.delete(f)))))}Promise.all(n).then(()=>{console.log("Cache cleared")}).catch(o=>{console.log("Error clearing cache"),console.error(o)})},$=async n=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const o=await B(),d=await N();await Promise.all(k.collections[n].languages.flatMap(f=>k.collections[n].files.flatMap(b=>{const y=E(n,f,b);return[T(d,y),o.delete(y)]}))),d.close(),C()}};r.useEffect(()=>{x(async()=>{await Promise.all([S(),C()])})},[]),r.useEffect(()=>{a&&(S(),C())},[a]);const U=async()=>{const n=await X(Object.keys(k.collections));t({message:s("cache.cacheAllModal.message",v(n)),buttons:[{message:s("cache.cacheAllModal.buttons.yes"),callback:A},{message:s("cache.cacheAllModal.buttons.no"),callback:()=>P(!1),autoFocus:!0}],cancelCallback:()=>P(!1)})},H=()=>{t({message:s("cache.cacheAllFailedModal.message"),buttons:[{message:s("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},q=async()=>{t({message:s("cache.clearCacheModal.message"),buttons:[{message:s("cache.clearCacheModal.buttons.yes"),callback:R},{message:s("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cache cache-button-group item-group",children:[e.jsx("button",{onClick:U,disabled:M!==!1,children:s("cacheAll")}),e.jsx("button",{onClick:q,children:s("clearCache")})]}),e.jsx("div",{className:"cache cache-results app-window",children:!l&&e.jsxs(e.Fragment,{children:[e.jsx(se,{cacheStorageEnabled:u,cachedFileInfo:w}),M?e.jsx(ae,{loadedBytes:I,totalBytes:L,progress:z}):e.jsx(ce,{cachedFileInfo:w,cacheCollections:A,clearCachedFile:$})]})})]})}export{ie as default};
