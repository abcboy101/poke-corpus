import{u as j,j as e,r as o}from"./vendor-ChvXBgSS.js";import{g as P,a as D,c as E,d as W,b as I,e as Y,f as _,h as K,i as ee,j as k,P as se,k as L,l as ae}from"./index-CqbONs9v.js";import"./react-dom-BkGmJbY0.js";import"./i18n-en-84MEhzKe.js";function ce(a){return new Worker("/poke-corpus/assets/cacheManagerWorker-EtAZhjWX.js",{name:a?.name})}function te({callback:a}){const{t:l}=j();return e.jsx("button",{className:"link",title:l("delete"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function ne({callback:a}){const{t:l}=j();return e.jsx("button",{className:"link",title:l("refresh"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function le({cacheStorageEnabled:a,cachedFileInfo:l}){const{t:c}=j(),r=o.useMemo(()=>k(l.reduce((x,[,d])=>x+d,0)),[l]);return e.jsxs("ul",{children:[e.jsx("li",{children:c("cache.storageStatus",{val:c(a?"cache.storageEnabled":"cache.storageDisabled")})}),a&&e.jsx("li",{children:c("cache.filesStored",{count:l.length})}),a&&e.jsx("li",{children:c("cache.storageUsed",r)})]})}function oe({loadedBytes:a,totalBytes:l,progress:c}){const{t:r}=j();return e.jsxs("div",{className:"cache-entry-notice",children:[r("cache.loading",{message:r("cache.inProgress"),loaded:r("cache.size",k(a)),total:r("cache.size",k(l))}),e.jsx(se,{progress:c})]})}function re({cachedFileInfo:a,cacheCollections:l,clearCachedFile:c}){const{t:r}=j(),x=o.useMemo(()=>L.map(f=>{const w=a.filter(([[u]])=>f===u);return[f,w.reduce((u,[,y])=>u+y,0),w.every(([,,u])=>u)]}).filter(([,f])=>f>0),[a]);return e.jsx("div",{className:"cache-entry-list",children:a.length>0&&x.map(([d,f,w],u)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:r(`collections:${d}.name`),children:e.jsx("span",{translate:"no",children:r(`collections:${d}.short`)})})}),e.jsx("div",{translate:"no",children:r("cache.size",k(f))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(ne,{callback:()=>{l(d)}}),e.jsx(te,{callback:()=>{c(d)}})]})]},u))})}function ge({active:a,showModal:l}){const{t:c}=j(),[r,x]=o.useTransition(),[d,f]=o.useState(!1),[w,u]=o.useState([]),[y,v]=o.useState(!1),[T,B]=o.useState(0),[z,F]=o.useState(0),[R,$]=o.useState(0),g=o.useRef(null),A=async()=>{f("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},U=s=>{const{status:t,loadedBytes:i,totalBytes:m,params:b}=s.data;switch(B(i/m),F(i),$(m),t){case"loading":return;case"done":console.log("Caching complete");break;case"error":console.log("Caching error");break}g.current?.terminate(),g.current=null,v(!1),S(b)},N=o.useCallback((s=null)=>{"caches"in window&&(v(!0),B(0),F(0),g.current===null&&(console.log("Creating new CacheManagerWorker..."),g.current=new ce,g.current.addEventListener("message",U),g.current.postMessage(s)))},[]),M=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await D(),m=Y.flatMap(([n,h])=>h.files.flatMap(p=>h.languages.map(V=>[n,V,p]))),b=m.map(([n,h,p])=>I(n,h,p)),C=await Promise.all(b.map(n=>_(t,i,n).then(async([h,p])=>[h!==void 0?(await h.blob()).size:-1,p])));u(C.map(([n,h],p)=>[m[p],n,h]).filter(([,n])=>n!==-1));const J=new Set(b),Q=(await K()).filter(n=>!J.has(n));await Promise.all(Q.flatMap(n=>W(i,n).then(()=>t.delete(n)).then(()=>{console.debug(`Deleted ${n} from cache`)}))),i.close(),s===null&&C.some(([n,h])=>n===-1||!h)&&G()}},S=s=>{M(s).catch(t=>{console.error(t)})},O=()=>{const s=[];g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&s.push(navigator.serviceWorker.ready.then(t=>t.unregister())),"indexedDB"in window&&"databases"in window.indexedDB&&s.push(ae().then(()=>M())),"caches"in window&&s.push(P().then(t=>t.keys().then(i=>Promise.all(i.map(m=>t.delete(m)))))),Promise.all(s).then(()=>{console.log("Cache cleared")}).catch(t=>{console.log("Error clearing cache"),console.error(t)})},X=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await D();await Promise.all(E.collections[s].languages.flatMap(m=>E.collections[s].files.flatMap(b=>{const C=I(s,m,b);return[W(i,C),t.delete(C)]}))),i.close(),S()}},Z=o.useCallback(s=>{X(s).catch(t=>{console.error(t)})},[]);o.useEffect(()=>{x(async()=>{await Promise.all([A(),M()])})},[]),o.useEffect(()=>{a&&x(async()=>{await Promise.all([A(),M()])})},[a]);const q=()=>{ee(L).then(s=>{l({message:c("cache.cacheAllModal.message",k(s)),buttons:[{message:c("cache.cacheAllModal.buttons.yes"),callback:N},{message:c("cache.cacheAllModal.buttons.no"),callback:()=>{v(!1)},autoFocus:!0}],cancelCallback:()=>{v(!1)}})}).catch(s=>{console.error(s)})},G=()=>{l({message:c("cache.cacheAllFailedModal.message"),buttons:[{message:c("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},H=()=>{l({message:c("cache.clearCacheModal.message"),buttons:[{message:c("cache.clearCacheModal.buttons.yes"),callback:O},{message:c("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return a&&e.jsxs("div",{className:"cache",children:[e.jsxs("div",{className:"cache-button-group item-group",children:[e.jsx("button",{onClick:q,disabled:y!==!1,children:c("cacheAll")}),e.jsx("button",{onClick:H,children:c("clearCache")})]}),e.jsx("div",{className:"cache-results app-window",children:!r&&e.jsxs("div",{className:"app-window-inner",children:[e.jsx(le,{cacheStorageEnabled:d,cachedFileInfo:w}),y?e.jsx(oe,{loadedBytes:z,totalBytes:R,progress:T}):e.jsx(re,{cachedFileInfo:w,cacheCollections:N,clearCachedFile:Z})]})})]})}export{ge as default};
