import{u as j,j as e,r}from"./vendor-klSkc7do.js";import{P as q,c as k,g as P,a as L,b as A,d as J,e as Q,f as E,h as X,i as Y}from"./search-2zSNZBf1.js";import{j as v}from"./index-C3Afrm5l.js";import"./react-dom-BXbkvITi.js";import"./i18n-en-Gm_Ew0Ko.js";function Z(c){return new Worker("/poke-corpus/assets/cacheManagerWorker-CTTNkGWa.js",{name:c?.name})}function _({callback:c}){const{t:a}=j();return e.jsx("button",{className:"link",title:a("delete"),onClick:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:"1em",viewBox:"-64 0 512 512",children:e.jsx("path",{d:"M170.5 51.6L151.5 80h145l-19-28.4c-1.5-2.2-4-3.6-6.7-3.6H177.1c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80H368h48 8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V128H24c-13.3 0-24-10.7-24-24S10.7 80 24 80h8H80 93.8l36.7-55.1C140.9 9.4 158.4 0 177.1 0h93.7c18.7 0 36.2 9.4 46.6 24.9zM80 128V432c0 17.7 14.3 32 32 32H336c17.7 0 32-14.3 32-32V128H80zm80 64V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16z",fill:"currentColor"})})})}function K({callback:c}){const{t:a}=j();return e.jsx("button",{className:"link",title:a("refresh"),onClick:c,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:"1em",viewBox:"-64 0 512 512",children:e.jsx("path",{d:"M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160 352 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l111.5 0c0 0 0 0 0 0l.4 0c17.7 0 32-14.3 32-32l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 35.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1L16 432c0 17.7 14.3 32 32 32s32-14.3 32-32l0-35.1 17.6 17.5c0 0 0 0 0 0c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.8c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-.1-.1L125.6 352l34.4 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L48.4 288c-1.6 0-3.2 .1-4.8 .3s-3.1 .5-4.6 1z",fill:"currentColor"})})})}function ee({cacheStorageEnabled:c,cachedFileInfo:a}){const{t:s}=j(),o=r.useMemo(()=>v(a.map(([,x])=>x).reduce((x,u)=>x+u,0)),[a]);return e.jsxs("ul",{children:[e.jsx("li",{children:s("cache.storageStatus",{val:s(c?"cache.storageEnabled":"cache.storageDisabled")})}),c&&e.jsx("li",{children:s("cache.filesStored",{count:a.length})}),c&&e.jsx("li",{children:s("cache.storageUsed",o)})]})}function se({loadedBytes:c,totalBytes:a,progress:s}){const{t:o}=j();return e.jsxs("div",{className:"cache-entry-notice",children:[o("cache.loading",{message:o("cache.inProgress"),loaded:o("cache.size",v(c)),total:o("cache.size",v(a))}),e.jsx(q,{progress:s})]})}function ce({cachedFileInfo:c,cacheCollections:a,clearCachedFile:s}){const{t:o}=j(),x=r.useMemo(()=>Object.entries(k.collections).map(([f])=>{const w=c.filter(([[i]])=>f===i);return[f,w.map(([,i])=>i).reduce((i,M)=>i+M,0),w.every(([,,i])=>i===!0)]}).filter(([,f])=>f>0),[c]);return e.jsx("div",{className:"cache-entry-list",children:c.length>0&&x.map(([u,f,w],i)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:o(`collections:${u}.name`),children:o(`collections:${u}.short`)})}),e.jsx("div",{children:o("cache.size",v(f))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(K,{callback:()=>a(u)}),e.jsx(_,{callback:()=>s(u)})]})]},i))})}function ie({active:c,showModal:a}){const{t:s}=j(),[o,x]=r.useTransition(),[u,f]=r.useState(!1),[w,i]=r.useState([]),[M,B]=r.useState(!1),[N,z]=r.useState(0),[V,F]=r.useState(0),[T,H]=r.useState(0),g=r.useRef(null),S=async()=>{f("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},W=t=>{const[n,h,m,b]=t.data;z(h/m),F(h),H(m),n!=="loading"&&(n==="done"?console.log("Caching complete"):n==="error"&&console.error("Caching error"),g.current?.terminate(),g.current=null,C(b),B(!1))},D=(t=null)=>{"caches"in window&&(B(!0),z(0),F(0),g.current===null&&(console.log("Creating new worker..."),g.current=new Z,g.current.addEventListener("message",W),g.current.postMessage(t)))},C=async t=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const n=await P(),h=await L(),m=Object.entries(k.collections).flatMap(([l,d])=>d.files.flatMap(p=>d.languages.map(G=>[l,G,p]))),b=m.map(([l,d,p])=>A(l,d,p)),y=await Promise.all(b.map(l=>J(n,h,l).then(async([d,p])=>[d!==void 0?(await d.blob()).size:-1,p])));i(y.map(([l,d],p)=>[m[p],l,d]).filter(([,l])=>l!==-1)),new Set(await Q()).difference(new Set(b)).forEach(l=>{console.debug(`Deleted ${l} from cache`),n.delete(l),E(h,l)}),h.close(),t===null&&y.some(([l,d])=>l===-1||!d)&&$()}},I=async()=>{g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(n=>n.unregister());const t=[];if("indexedDB"in window&&"databases"in window.indexedDB&&t.push(Y().then(()=>C())),"caches"in window){const n=await P();t.push(n.keys().then(h=>Promise.all(h.map(m=>n.delete(m)))))}Promise.all(t).then(()=>{console.log("Cache cleared")}).catch(n=>{console.log("Error clearing cache"),console.error(n)})},O=async t=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const n=await P(),h=await L();await Promise.all(k.collections[t].languages.flatMap(m=>k.collections[t].files.flatMap(b=>{const y=A(t,m,b);return[E(h,y),n.delete(y)]}))),h.close(),C()}};r.useEffect(()=>{x(async()=>{await Promise.all([S(),C()])})},[]),r.useEffect(()=>{c&&(S(),C())},[c]);const R=async()=>{const t=await X(Object.keys(k.collections));a({message:s("cache.cacheAllModal.message",v(t)),buttons:[{message:s("cache.cacheAllModal.buttons.yes"),callback:D},{message:s("cache.cacheAllModal.buttons.no"),callback:()=>B(!1),autoFocus:!0}],cancelCallback:()=>B(!1)})},$=()=>{a({message:s("cache.cacheAllFailedModal.message"),buttons:[{message:s("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},U=async()=>{a({message:s("cache.clearCacheModal.message"),buttons:[{message:s("cache.clearCacheModal.buttons.yes"),callback:I},{message:s("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cache cache-button-group item-group",children:[e.jsx("button",{onClick:R,disabled:M!==!1,children:s("cacheAll")}),e.jsx("button",{onClick:U,children:s("clearCache")})]}),e.jsx("div",{className:"cache cache-results app-window",children:!o&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{cacheStorageEnabled:u,cachedFileInfo:w}),M?e.jsx(se,{loadedBytes:V,totalBytes:T,progress:N}):e.jsx(ce,{cachedFileInfo:w,cacheCollections:D,clearCachedFile:O})]})})]})}export{ie as default};
