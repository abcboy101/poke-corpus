import{u as b,j as e,r as l}from"./vendor-ZM8Ga059.js";import{g as P,a as D,c as E,d as W,b as z,e as Z,f as _,h as K,i as ee,j as k,P as se,k as I,l as ae}from"./index-Cfj4KWkD.js";import"./react-dom-BzboLVQ4.js";import"./i18n-en-84MEhzKe.js";function ce(a){return new Worker("/poke-corpus/assets/cacheManagerWorker-Ba3GYVz4.js",{name:a?.name})}function te({callback:a}){const{t:o}=b();return e.jsx("button",{className:"link",title:o("delete"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function ne({callback:a}){const{t:o}=b();return e.jsx("button",{className:"link",title:o("refresh"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function oe({cacheStorageEnabled:a,cachedFileInfo:o}){const{t:c}=b(),r=l.useMemo(()=>k(o.reduce((j,[,d])=>j+d,0)),[o]);return e.jsxs("ul",{children:[e.jsx("li",{children:c("cache.storageStatus",{val:c(a?"cache.storageEnabled":"cache.storageDisabled")})}),a&&e.jsx("li",{children:c("cache.filesStored",{count:o.length})}),a&&e.jsx("li",{children:c("cache.storageUsed",r)})]})}function le({loadedBytes:a,totalBytes:o,progress:c}){const{t:r}=b();return e.jsxs("div",{className:"cache-entry-notice",children:[r("cache.loading",{message:r("cache.inProgress"),loaded:r("cache.size",k(a)),total:r("cache.size",k(o))}),e.jsx(se,{progress:c})]})}function re({cachedFileInfo:a,cacheCollections:o,clearCachedFile:c}){const{t:r}=b(),j=l.useMemo(()=>I.map(f=>{const w=a.filter(([[u]])=>f===u);return[f,w.reduce((u,[,y])=>u+y,0),w.every(([,,u])=>u)]}).filter(([,f])=>f>0),[a]);return e.jsx("div",{className:"cache-entry-list",children:a.length>0&&j.map(([d,f,w],u)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:r(`collections:${d}.name`),children:r(`collections:${d}.short`)})}),e.jsx("div",{children:r("cache.size",k(f))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(ne,{callback:()=>{o(d)}}),e.jsx(te,{callback:()=>{c(d)}})]})]},u))})}function ge({active:a,showModal:o}){const{t:c}=b(),[r,j]=l.useTransition(),[d,f]=l.useState(!1),[w,u]=l.useState([]),[y,v]=l.useState(!1),[L,B]=l.useState(0),[T,F]=l.useState(0),[R,$]=l.useState(0),g=l.useRef(null),N=async()=>{f("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},U=s=>{const[t,i,m,x]=s.data;switch(B(i/m),F(i),$(m),t){case"loading":return;case"done":console.log("Caching complete");break;case"error":console.log("Caching error");break}g.current?.terminate(),g.current=null,v(!1),A(x)},S=l.useCallback((s=null)=>{"caches"in window&&(v(!0),B(0),F(0),g.current===null&&(console.log("Creating new CacheManagerWorker..."),g.current=new ce,g.current.addEventListener("message",U),g.current.postMessage(s)))},[]),M=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await D(),m=Z.flatMap(([n,h])=>h.files.flatMap(p=>h.languages.map(X=>[n,X,p]))),x=m.map(([n,h,p])=>z(n,h,p)),C=await Promise.all(x.map(n=>_(t,i,n).then(async([h,p])=>[h!==void 0?(await h.blob()).size:-1,p])));u(C.map(([n,h],p)=>[m[p],n,h]).filter(([,n])=>n!==-1));const J=new Set(x),Q=(await K()).filter(n=>!J.has(n));await Promise.all(Q.flatMap(n=>W(i,n).then(()=>t.delete(n)).then(()=>{console.debug(`Deleted ${n} from cache`)}))),i.close(),s===null&&C.some(([n,h])=>n===-1||!h)&&q()}},A=s=>{M(s).catch(t=>{console.error(t)})},G=()=>{const s=[];g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&s.push(navigator.serviceWorker.ready.then(t=>t.unregister())),"indexedDB"in window&&"databases"in window.indexedDB&&s.push(ae().then(()=>M())),"caches"in window&&s.push(P().then(t=>t.keys().then(i=>Promise.all(i.map(m=>t.delete(m)))))),Promise.all(s).then(()=>{console.log("Cache cleared")}).catch(t=>{console.log("Error clearing cache"),console.error(t)})},O=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await D();await Promise.all(E.collections[s].languages.flatMap(m=>E.collections[s].files.flatMap(x=>{const C=z(s,m,x);return[W(i,C),t.delete(C)]}))),i.close(),A()}},V=l.useCallback(s=>{O(s).catch(t=>{console.error(t)})},[]);l.useEffect(()=>{j(async()=>{await Promise.all([N(),M()])})},[]),l.useEffect(()=>{a&&Promise.all([N(),M()]).catch(s=>{console.error(s)})},[a]);const Y=()=>{ee(I).then(s=>{o({message:c("cache.cacheAllModal.message",k(s)),buttons:[{message:c("cache.cacheAllModal.buttons.yes"),callback:S},{message:c("cache.cacheAllModal.buttons.no"),callback:()=>{v(!1)},autoFocus:!0}],cancelCallback:()=>{v(!1)}})}).catch(s=>{console.error(s)})},q=()=>{o({message:c("cache.cacheAllFailedModal.message"),buttons:[{message:c("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},H=()=>{o({message:c("cache.clearCacheModal.message"),buttons:[{message:c("cache.clearCacheModal.buttons.yes"),callback:G},{message:c("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return a&&e.jsxs("div",{className:"cache",children:[e.jsxs("div",{className:"cache-button-group item-group",children:[e.jsx("button",{onClick:Y,disabled:y!==!1,children:c("cacheAll")}),e.jsx("button",{onClick:H,children:c("clearCache")})]}),e.jsx("div",{className:"cache-results app-window",children:!r&&e.jsxs("div",{className:"app-window-inner",children:[e.jsx(oe,{cacheStorageEnabled:d,cachedFileInfo:w}),y?e.jsx(le,{loadedBytes:T,totalBytes:R,progress:L}):e.jsx(re,{cachedFileInfo:w,cacheCollections:S,clearCachedFile:V})]})})]})}export{ge as default};
