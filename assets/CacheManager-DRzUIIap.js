import{u as j,j as e,r as l}from"./vendor-ChvXBgSS.js";import{g as P,a as A,c as E,d as I,b as W,e as Z,f as _,h as K,i as ee,j as k,P as se,k as L,l as ae}from"./index-DJ-Jkfna.js";import"./react-dom-BkGmJbY0.js";import"./i18n-en-84MEhzKe.js";function ce(a){return new Worker("/poke-corpus/assets/cacheManagerWorker-DmHitKIk.js",{name:a?.name})}function te({callback:a}){const{t:o}=j();return e.jsx("button",{className:"link",title:o("delete"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function ne({callback:a}){const{t:o}=j();return e.jsx("button",{className:"link",title:o("refresh"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function oe({cacheStorageEnabled:a,cachedFileInfo:o}){const{t:c}=j(),r=l.useMemo(()=>k(o.reduce((x,[,d])=>x+d,0)),[o]);return e.jsxs("ul",{children:[e.jsx("li",{children:c("cache.storageStatus",{val:c(a?"cache.storageEnabled":"cache.storageDisabled")})}),a&&e.jsx("li",{children:c("cache.filesStored",{count:o.length})}),a&&e.jsx("li",{children:c("cache.storageUsed",r)})]})}function le({loadedBytes:a,totalBytes:o,progress:c}){const{t:r}=j();return e.jsxs("div",{className:"cache-entry-notice",children:[r("cache.loading",{message:r("cache.inProgress"),loaded:r("cache.size",k(a)),total:r("cache.size",k(o))}),e.jsx(se,{progress:c})]})}function re({cachedFileInfo:a,cacheCollections:o,clearCachedFile:c}){const{t:r}=j(),x=l.useMemo(()=>L.map(f=>{const w=a.filter(([[u]])=>f===u);return[f,w.reduce((u,[,y])=>u+y,0),w.every(([,,u])=>u)]}).filter(([,f])=>f>0),[a]);return e.jsx("div",{className:"cache-entry-list",children:a.length>0&&x.map(([d,f,w],u)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:r(`collections:${d}.name`),children:r(`collections:${d}.short`)})}),e.jsx("div",{children:r("cache.size",k(f))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(ne,{callback:()=>{o(d)}}),e.jsx(te,{callback:()=>{c(d)}})]})]},u))})}function ge({active:a,showModal:o}){const{t:c}=j(),[r,x]=l.useTransition(),[d,f]=l.useState(!1),[w,u]=l.useState([]),[y,v]=l.useState(!1),[T,B]=l.useState(0),[z,F]=l.useState(0),[R,$]=l.useState(0),g=l.useRef(null),D=async()=>{f("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},U=s=>{const{status:t,loadedBytes:i,totalBytes:m,params:b}=s.data;switch(B(i/m),F(i),$(m),t){case"loading":return;case"done":console.log("Caching complete");break;case"error":console.log("Caching error");break}g.current?.terminate(),g.current=null,v(!1),S(b)},N=l.useCallback((s=null)=>{"caches"in window&&(v(!0),B(0),F(0),g.current===null&&(console.log("Creating new CacheManagerWorker..."),g.current=new ce,g.current.addEventListener("message",U),g.current.postMessage(s)))},[]),M=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await A(),m=Z.flatMap(([n,h])=>h.files.flatMap(p=>h.languages.map(Y=>[n,Y,p]))),b=m.map(([n,h,p])=>W(n,h,p)),C=await Promise.all(b.map(n=>_(t,i,n).then(async([h,p])=>[h!==void 0?(await h.blob()).size:-1,p])));u(C.map(([n,h],p)=>[m[p],n,h]).filter(([,n])=>n!==-1));const V=new Set(b),X=(await K()).filter(n=>!V.has(n));await Promise.all(X.flatMap(n=>I(i,n).then(()=>t.delete(n)).then(()=>{console.debug(`Deleted ${n} from cache`)}))),i.close(),s===null&&C.some(([n,h])=>n===-1||!h)&&J()}},S=s=>{M(s).catch(t=>{console.error(t)})},H=()=>{const s=[];g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&s.push(navigator.serviceWorker.ready.then(t=>t.unregister())),"indexedDB"in window&&"databases"in window.indexedDB&&s.push(ae().then(()=>M())),"caches"in window&&s.push(P().then(t=>t.keys().then(i=>Promise.all(i.map(m=>t.delete(m)))))),Promise.all(s).then(()=>{console.log("Cache cleared")}).catch(t=>{console.log("Error clearing cache"),console.error(t)})},O=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await A();await Promise.all(E.collections[s].languages.flatMap(m=>E.collections[s].files.flatMap(b=>{const C=W(s,m,b);return[I(i,C),t.delete(C)]}))),i.close(),S()}},q=l.useCallback(s=>{O(s).catch(t=>{console.error(t)})},[]);l.useEffect(()=>{x(async()=>{await Promise.all([D(),M()])})},[]),l.useEffect(()=>{a&&x(async()=>{await Promise.all([D(),M()])})},[a]);const G=()=>{ee(L).then(s=>{o({message:c("cache.cacheAllModal.message",k(s)),buttons:[{message:c("cache.cacheAllModal.buttons.yes"),callback:N},{message:c("cache.cacheAllModal.buttons.no"),callback:()=>{v(!1)},autoFocus:!0}],cancelCallback:()=>{v(!1)}})}).catch(s=>{console.error(s)})},J=()=>{o({message:c("cache.cacheAllFailedModal.message"),buttons:[{message:c("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},Q=()=>{o({message:c("cache.clearCacheModal.message"),buttons:[{message:c("cache.clearCacheModal.buttons.yes"),callback:H},{message:c("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return a&&e.jsxs("div",{className:"cache",children:[e.jsxs("div",{className:"cache-button-group item-group",children:[e.jsx("button",{onClick:G,disabled:y!==!1,children:c("cacheAll")}),e.jsx("button",{onClick:Q,children:c("clearCache")})]}),e.jsx("div",{className:"cache-results app-window",children:!r&&e.jsxs("div",{className:"app-window-inner",children:[e.jsx(oe,{cacheStorageEnabled:d,cachedFileInfo:w}),y?e.jsx(le,{loadedBytes:z,totalBytes:R,progress:T}):e.jsx(re,{cachedFileInfo:w,cacheCollections:N,clearCachedFile:q})]})})]})}export{ge as default};
