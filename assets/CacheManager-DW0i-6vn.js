import{u as k,j as e,r as h}from"./vendor-CBRh5X3R.js";import{P as G,g as C,a as S,c as w,b as z,d as J,e as Q,f as P,h as X,i as Y}from"./search-BrF8-Nxt.js";import{h as x}from"./index-CSeKf0ah.js";import"./react-dom-ZZpn9oTq.js";import"./i18n-en-Gm_Ew0Ko.js";function Z(r){return new Worker("/poke-corpus/assets/cacheManagerWorker-uTqjEioN.js",{name:r==null?void 0:r.name})}function _({callback:r}){const{t:g}=k();return e.jsx("button",{className:"link",title:g("delete"),onClick:r,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:"1em",viewBox:"-64 0 512 512",children:e.jsx("path",{d:"M170.5 51.6L151.5 80h145l-19-28.4c-1.5-2.2-4-3.6-6.7-3.6H177.1c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80H368h48 8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V128H24c-13.3 0-24-10.7-24-24S10.7 80 24 80h8H80 93.8l36.7-55.1C140.9 9.4 158.4 0 177.1 0h93.7c18.7 0 36.2 9.4 46.6 24.9zM80 128V432c0 17.7 14.3 32 32 32H336c17.7 0 32-14.3 32-32V128H80zm80 64V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16z",fill:"currentColor"})})})}function K({callback:r}){const{t:g}=k();return e.jsx("button",{className:"link",title:g("refresh"),onClick:r,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",height:"1em",viewBox:"-64 0 512 512",children:e.jsx("path",{d:"M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160 352 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l111.5 0c0 0 0 0 0 0l.4 0c17.7 0 32-14.3 32-32l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 35.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1L16 432c0 17.7 14.3 32 32 32s32-14.3 32-32l0-35.1 17.6 17.5c0 0 0 0 0 0c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.8c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-.1-.1L125.6 352l34.4 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L48.4 288c-1.6 0-3.2 .1-4.8 .3s-3.1 .5-4.6 1z",fill:"currentColor"})})})}function ne({active:r,showModal:g}){const{t:s}=k(),[j,D]=h.useState(!0),[b,E]=h.useState([]),[v,p]=h.useState(!1),[L,y]=h.useState(0),[A,M]=h.useState(0),[I,N]=h.useState(0),i=h.useRef(null),B=async()=>{D("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},V=c=>{var u;const[a,l,t,d]=c.data;y(l/t),M(l),N(t),a!=="loading"&&(a==="done"?console.log("Caching complete"):a==="error"&&console.error("Caching error"),(u=i.current)==null||u.terminate(),i.current=null,f(d),p(!1))},F=(c=null)=>{"caches"in window&&(p(!0),y(0),M(0),i.current===null&&(console.log("Creating new worker..."),i.current=new Z,i.current.addEventListener("message",V),i.current.postMessage(c)))},f=async c=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const a=await C(),l=await S(),t=Object.entries(w.collections).flatMap(([n,o])=>o.files.flatMap(m=>o.languages.map(q=>[n,q,m]))),d=t.map(([n,o,m])=>z(n,o,m)),u=await Promise.all(d.map(n=>J(a,l,n).then(async([o,m])=>[o!==void 0?(await o.blob()).size:-1,m])));E(u.map(([n,o],m)=>[t[m],n,o]).filter(([,n])=>n!==-1)),new Set(await Q()).difference(new Set(d)).forEach(n=>{console.debug(`Deleted ${n} from cache`),a.delete(n),P(l,n)}),l.close(),c===null&&u.some(([n,o])=>n===-1||!o)&&$()}},H=async()=>{i.current&&(i.current.terminate(),i.current=null),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(a=>a.unregister());const c=[];if("indexedDB"in window&&"databases"in window.indexedDB&&c.push(Y().then(()=>f())),"caches"in window){const a=await C();c.push(a.keys().then(l=>Promise.all(l.map(t=>a.delete(t)))))}Promise.all(c).then(()=>{console.log("Cache cleared")}).catch(a=>{console.log("Error clearing cache"),console.error(a)})},T=async c=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const a=await C(),l=await S();await Promise.all(w.collections[c].languages.flatMap(t=>w.collections[c].files.flatMap(d=>{const u=z(c,t,d);return[P(l,u),a.delete(u)]}))),l.close(),f()}};h.useEffect(()=>{B(),f()},[]),h.useEffect(()=>{r&&(B(),f())},[r]);const W=()=>x(b.map(([,c])=>c).reduce((c,a)=>c+a,0)),O=()=>Object.entries(w.collections).map(([a])=>{const l=b.filter(([[t]])=>a===t);return[a,l.map(([,t])=>t).reduce((t,d)=>t+d,0),l.every(([,,t])=>t===!0)]}).filter(([,a])=>a>0),R=async()=>{const c=await X(Object.keys(w.collections));g({message:s("cache.cacheAllModal.message",x(c)),buttons:[{message:s("cache.cacheAllModal.buttons.yes"),callback:F},{message:s("cache.cacheAllModal.buttons.no"),callback:()=>p(!1),autoFocus:!0}],cancelCallback:()=>p(!1)})},$=()=>{g({message:s("cache.cacheAllFailedModal.message"),buttons:[{message:s("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},U=async()=>{g({message:s("cache.clearCacheModal.message"),buttons:[{message:s("cache.clearCacheModal.buttons.yes"),callback:H},{message:s("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cache cache-button-group item-group",children:[e.jsx("button",{onClick:R,disabled:v!==!1,children:s("cacheAll")}),e.jsx("button",{onClick:U,children:s("clearCache")})]}),e.jsxs("div",{className:"cache cache-results app-window",children:[e.jsxs("ul",{children:[e.jsx("li",{children:s("cache.storageStatus",{val:s(j?"cache.storageEnabled":"cache.storageDisabled")})}),j&&e.jsx("li",{children:s("cache.filesStored",{count:b.length})}),j&&e.jsx("li",{children:s("cache.storageUsed",W())})]}),v?e.jsxs("div",{className:"cache-entry-notice",children:[s("cache.loading",{message:s("cache.inProgress"),loaded:s("cache.size",x(A)),total:s("cache.size",x(I))}),e.jsx(G,{progress:L})]}):e.jsx("div",{className:"cache-entry-list",children:b.length>0&&O().map(([c,a,l],t)=>e.jsxs("div",{className:`cache-entry cache-entry-${l?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:s(`collections:${c}.name`),children:s(`collections:${c}.short`)})}),e.jsx("div",{children:s("cache.size",x(a))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!l&&e.jsx(K,{callback:()=>F(c)}),e.jsx(_,{callback:()=>T(c)})]})]},t))})]})]})}export{ne as default};
