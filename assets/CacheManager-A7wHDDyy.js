import{u as b,j as e,r}from"./vendor-C0iXxd-T.js";import{g as P,a as N,c as Z,b as E,d as _,e as K,f as W,h as ee,i as k,P as se,j as I,k as ae,l as z}from"./index-0AxVGJkq.js";import"./react-dom-CwkuqcRR.js";import"./i18n-en-84MEhzKe.js";function ce(c){return new Worker("/poke-corpus/assets/cacheManagerWorker-Ba3GYVz4.js",{name:c?.name})}function te({callback:c}){const{t:o}=b();return e.jsx("button",{className:"link",title:o("delete"),onClick:c,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function ne({callback:c}){const{t:o}=b();return e.jsx("button",{className:"link",title:o("refresh"),onClick:c,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function oe({cacheStorageEnabled:c,cachedFileInfo:o}){const{t:a}=b(),l=r.useMemo(()=>k(o.reduce((j,[,d])=>j+d,0)),[o]);return e.jsxs("ul",{children:[e.jsx("li",{children:a("cache.storageStatus",{val:a(c?"cache.storageEnabled":"cache.storageDisabled")})}),c&&e.jsx("li",{children:a("cache.filesStored",{count:o.length})}),c&&e.jsx("li",{children:a("cache.storageUsed",l)})]})}function le({loadedBytes:c,totalBytes:o,progress:a}){const{t:l}=b();return e.jsxs("div",{className:"cache-entry-notice",children:[l("cache.loading",{message:l("cache.inProgress"),loaded:l("cache.size",k(c)),total:l("cache.size",k(o))}),e.jsx(se,{progress:a})]})}function re({cachedFileInfo:c,cacheCollections:o,clearCachedFile:a}){const{t:l}=b(),j=r.useMemo(()=>I.map(f=>{const w=c.filter(([[u]])=>f===u);return[f,w.reduce((u,[,y])=>u+y,0),w.every(([,,u])=>u)]}).filter(([,f])=>f>0),[c]);return e.jsx("div",{className:"cache-entry-list",children:c.length>0&&j.map(([d,f,w],u)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:l(`collections:${d}.name`),children:l(`collections:${d}.short`)})}),e.jsx("div",{children:l("cache.size",k(f))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(ne,{callback:()=>{o(d)}}),e.jsx(te,{callback:()=>{a(d)}})]})]},u))})}function ge({active:c,showModal:o}){const{t:a}=b(),[l,j]=r.useTransition(),[d,f]=r.useState(!1),[w,u]=r.useState([]),[y,v]=r.useState(!1),[L,B]=r.useState(0),[T,F]=r.useState(0),[R,$]=r.useState(0),g=r.useRef(null),S=async()=>{f("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},U=s=>{const[t,i,m,p]=s.data;switch(B(i/m),F(i),$(m),t){case"loading":return;case"done":console.log("Caching complete");break;case"error":console.log("Caching error");break}g.current?.terminate(),g.current=null,v(!1),D(p)},A=(s=null)=>{"caches"in window&&(v(!0),B(0),F(0),g.current===null&&(console.log("Creating new CacheManagerWorker..."),g.current=new ce,g.current.addEventListener("message",U),g.current.postMessage(s)))},M=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await N(),m=Z.flatMap(([n,h])=>h.files.flatMap(x=>h.languages.map(X=>[n,X,x]))),p=m.map(([n,h,x])=>E(n,h,x)),C=await Promise.all(p.map(n=>_(t,i,n).then(async([h,x])=>[h!==void 0?(await h.blob()).size:-1,x])));u(C.map(([n,h],x)=>[m[x],n,h]).filter(([,n])=>n!==-1));const J=new Set(p),Q=(await K()).filter(n=>!J.has(n));await Promise.all(Q.flatMap(n=>W(i,n).then(()=>t.delete(n)).then(()=>{console.debug(`Deleted ${n} from cache`)}))),i.close(),s===null&&C.some(([n,h])=>n===-1||!h)&&q()}},D=s=>{M(s).catch(t=>{console.error(t)})},G=()=>{const s=[];g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&s.push(navigator.serviceWorker.ready.then(t=>t.unregister())),"indexedDB"in window&&"databases"in window.indexedDB&&s.push(ae().then(()=>M())),"caches"in window&&s.push(P().then(t=>t.keys().then(i=>Promise.all(i.map(m=>t.delete(m)))))),Promise.all(s).then(()=>{console.log("Cache cleared")}).catch(t=>{console.log("Error clearing cache"),console.error(t)})},O=async s=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const t=await P(),i=await N();await Promise.all(z.collections[s].languages.flatMap(m=>z.collections[s].files.flatMap(p=>{const C=E(s,m,p);return[W(i,C),t.delete(C)]}))),i.close(),D()}},V=s=>{O(s).catch(t=>{console.error(t)})};r.useEffect(()=>{j(async()=>{await Promise.all([S(),M()])})},[]),r.useEffect(()=>{c&&Promise.all([S(),M()]).catch(s=>{console.error(s)})},[c]);const Y=()=>{ee(I).then(s=>{o({message:a("cache.cacheAllModal.message",k(s)),buttons:[{message:a("cache.cacheAllModal.buttons.yes"),callback:A},{message:a("cache.cacheAllModal.buttons.no"),callback:()=>{v(!1)},autoFocus:!0}],cancelCallback:()=>{v(!1)}})}).catch(s=>{console.error(s)})},q=()=>{o({message:a("cache.cacheAllFailedModal.message"),buttons:[{message:a("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},H=()=>{o({message:a("cache.clearCacheModal.message"),buttons:[{message:a("cache.clearCacheModal.buttons.yes"),callback:G},{message:a("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cache cache-button-group item-group",children:[e.jsx("button",{onClick:Y,disabled:y!==!1,children:a("cacheAll")}),e.jsx("button",{onClick:H,children:a("clearCache")})]}),e.jsx("div",{className:"cache cache-results app-window",children:!l&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{cacheStorageEnabled:d,cachedFileInfo:w}),y?e.jsx(le,{loadedBytes:T,totalBytes:R,progress:L}):e.jsx(re,{cachedFileInfo:w,cacheCollections:A,clearCachedFile:V})]})})]})}export{ge as default};
