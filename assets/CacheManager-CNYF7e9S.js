import{u as b,j as e,r}from"./vendor-C0iXxd-T.js";import{g as B,a as A,c as k,b as E,d as J,e as Q,f as T,h as X,i as v,P as Y,j as Z}from"./index-CCOlyDh-.js";import"./react-dom-CwkuqcRR.js";import"./i18n-en-BTz_pYLY.js";function _(a){return new Worker("/poke-corpus/assets/cacheManagerWorker-BOcgVPy1.js",{name:a?.name})}function K({callback:a}){const{t}=b();return e.jsx("button",{className:"link",title:t("delete"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function ee({callback:a}){const{t}=b();return e.jsx("button",{className:"link",title:t("refresh"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function se({cacheStorageEnabled:a,cachedFileInfo:t}){const{t:s}=b(),l=r.useMemo(()=>v(t.reduce((j,[,h])=>j+h,0)),[t]);return e.jsxs("ul",{children:[e.jsx("li",{children:s("cache.storageStatus",{val:s(a?"cache.storageEnabled":"cache.storageDisabled")})}),a&&e.jsx("li",{children:s("cache.filesStored",{count:t.length})}),a&&e.jsx("li",{children:s("cache.storageUsed",l)})]})}function ae({loadedBytes:a,totalBytes:t,progress:s}){const{t:l}=b();return e.jsxs("div",{className:"cache-entry-notice",children:[l("cache.loading",{message:l("cache.inProgress"),loaded:l("cache.size",v(a)),total:l("cache.size",v(t))}),e.jsx(Y,{progress:s})]})}function ce({cachedFileInfo:a,cacheCollections:t,clearCachedFile:s}){const{t:l}=b(),j=r.useMemo(()=>Object.entries(k.collections).map(([m])=>{const w=a.filter(([[u]])=>m===u);return[m,w.reduce((u,[,M])=>u+M,0),w.every(([,,u])=>u===!0)]}).filter(([,m])=>m>0),[a]);return e.jsx("div",{className:"cache-entry-list",children:a.length>0&&j.map(([h,m,w],u)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:l(`collections:${h}.name`),children:l(`collections:${h}.short`)})}),e.jsx("div",{children:l("cache.size",v(m))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(ee,{callback:()=>t(h)}),e.jsx(K,{callback:()=>s(h)})]})]},u))})}function ie({active:a,showModal:t}){const{t:s}=b(),[l,j]=r.useTransition(),[h,m]=r.useState(!1),[w,u]=r.useState([]),[M,P]=r.useState(!1),[z,F]=r.useState(0),[I,D]=r.useState(0),[L,W]=r.useState(0),g=r.useRef(null),S=async()=>{m("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},O=n=>{const[o,i,f,p]=n.data;F(i/f),D(i),W(f),o!=="loading"&&(o==="done"?console.log("Caching complete"):o==="error"&&console.error("Caching error"),g.current?.terminate(),g.current=null,C(p),P(!1))},N=(n=null)=>{"caches"in window&&(P(!0),F(0),D(0),g.current===null&&(console.log("Creating new worker..."),g.current=new _,g.current.addEventListener("message",O),g.current.postMessage(n)))},C=async n=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const o=await B(),i=await A(),f=Object.entries(k.collections).flatMap(([c,d])=>d.files.flatMap(x=>d.languages.map(H=>[c,H,x]))),p=f.map(([c,d,x])=>E(c,d,x)),y=await Promise.all(p.map(c=>J(o,i,c).then(async([d,x])=>[d!==void 0?(await d.blob()).size:-1,x])));u(y.map(([c,d],x)=>[f[x],c,d]).filter(([,c])=>c!==-1));const G=new Set(p);(await Q()).filter(c=>!G.has(c)).forEach(c=>{console.debug(`Deleted ${c} from cache`),o.delete(c),T(i,c)}),i.close(),n===null&&y.some(([c,d])=>c===-1||!d)&&V()}},R=async()=>{g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(o=>o.unregister());const n=[];if("indexedDB"in window&&"databases"in window.indexedDB&&n.push(Z().then(()=>C())),"caches"in window){const o=await B();n.push(o.keys().then(i=>Promise.all(i.map(f=>o.delete(f)))))}Promise.all(n).then(()=>{console.log("Cache cleared")}).catch(o=>{console.log("Error clearing cache"),console.error(o)})},$=async n=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const o=await B(),i=await A();await Promise.all(k.collections[n].languages.flatMap(f=>k.collections[n].files.flatMap(p=>{const y=E(n,f,p);return[T(i,y),o.delete(y)]}))),i.close(),C()}};r.useEffect(()=>{j(async()=>{await Promise.all([S(),C()])})},[]),r.useEffect(()=>{a&&(S(),C())},[a]);const U=async()=>{const n=await X(Object.keys(k.collections));t({message:s("cache.cacheAllModal.message",v(n)),buttons:[{message:s("cache.cacheAllModal.buttons.yes"),callback:N},{message:s("cache.cacheAllModal.buttons.no"),callback:()=>P(!1),autoFocus:!0}],cancelCallback:()=>P(!1)})},V=()=>{t({message:s("cache.cacheAllFailedModal.message"),buttons:[{message:s("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},q=async()=>{t({message:s("cache.clearCacheModal.message"),buttons:[{message:s("cache.clearCacheModal.buttons.yes"),callback:R},{message:s("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cache cache-button-group item-group",children:[e.jsx("button",{onClick:U,disabled:M!==!1,children:s("cacheAll")}),e.jsx("button",{onClick:q,children:s("clearCache")})]}),e.jsx("div",{className:"cache cache-results app-window",children:!l&&e.jsxs(e.Fragment,{children:[e.jsx(se,{cacheStorageEnabled:h,cachedFileInfo:w}),M?e.jsx(ae,{loadedBytes:I,totalBytes:L,progress:z}):e.jsx(ce,{cachedFileInfo:w,cacheCollections:N,clearCachedFile:$})]})})]})}export{ie as default};
