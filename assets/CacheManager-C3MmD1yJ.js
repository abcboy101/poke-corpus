import{u as j,j as e,r}from"./vendor-RneNGchg.js";import{f as v,P as H,c as k,g as B,a as A,b as E,d as Q,e as V,h as T,i as X,j as Y}from"./index-C8vskLNP.js";import"./react-dom-CtFnp2LN.js";import"./i18n-en-D63pAsxe.js";function Z(a){return new Worker("/poke-corpus/assets/cacheManagerWorker-CJ85p4yO.js",{name:a?.name})}function _({callback:a}){const{t:c}=j();return e.jsx("button",{className:"link",title:c("delete"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#trash-can"})})})}function K({callback:a}){const{t:c}=j();return e.jsx("button",{className:"link",title:c("refresh"),onClick:a,children:e.jsx("svg",{className:"icon",children:e.jsx("use",{href:"sprites.svg#arrows-rotate"})})})}function ee({cacheStorageEnabled:a,cachedFileInfo:c}){const{t:s}=j(),l=r.useMemo(()=>v(c.map(([,x])=>x).reduce((x,u)=>x+u,0)),[c]);return e.jsxs("ul",{children:[e.jsx("li",{children:s("cache.storageStatus",{val:s(a?"cache.storageEnabled":"cache.storageDisabled")})}),a&&e.jsx("li",{children:s("cache.filesStored",{count:c.length})}),a&&e.jsx("li",{children:s("cache.storageUsed",l)})]})}function se({loadedBytes:a,totalBytes:c,progress:s}){const{t:l}=j();return e.jsxs("div",{className:"cache-entry-notice",children:[l("cache.loading",{message:l("cache.inProgress"),loaded:l("cache.size",v(a)),total:l("cache.size",v(c))}),e.jsx(H,{progress:s})]})}function ae({cachedFileInfo:a,cacheCollections:c,clearCachedFile:s}){const{t:l}=j(),x=r.useMemo(()=>Object.entries(k.collections).map(([m])=>{const w=a.filter(([[i]])=>m===i);return[m,w.map(([,i])=>i).reduce((i,M)=>i+M,0),w.every(([,,i])=>i===!0)]}).filter(([,m])=>m>0),[a]);return e.jsx("div",{className:"cache-entry-list",children:a.length>0&&x.map(([u,m,w],i)=>e.jsxs("div",{className:`cache-entry cache-entry-${w?"current":"outdated"}`,children:[e.jsxs("div",{className:"cache-entry-text",children:[e.jsx("div",{children:e.jsx("abbr",{title:l(`collections:${u}.name`),children:l(`collections:${u}.short`)})}),e.jsx("div",{children:l("cache.size",v(m))})]}),e.jsxs("div",{className:"cache-entry-actions",children:[!w&&e.jsx(K,{callback:()=>c(u)}),e.jsx(_,{callback:()=>s(u)})]})]},i))})}function re({active:a,showModal:c}){const{t:s}=j(),[l,x]=r.useTransition(),[u,m]=r.useState(!1),[w,i]=r.useState([]),[M,P]=r.useState(!1),[z,F]=r.useState(0),[I,D]=r.useState(0),[L,W]=r.useState(0),g=r.useRef(null),S=async()=>{m("caches"in window&&await window.caches.keys().then(()=>!0).catch(()=>!1))},O=t=>{const[n,d,f,b]=t.data;F(d/f),D(d),W(f),n!=="loading"&&(n==="done"?console.log("Caching complete"):n==="error"&&console.error("Caching error"),g.current?.terminate(),g.current=null,C(b),P(!1))},N=(t=null)=>{"caches"in window&&(P(!0),F(0),D(0),g.current===null&&(console.log("Creating new worker..."),g.current=new Z,g.current.addEventListener("message",O),g.current.postMessage(t)))},C=async t=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const n=await B(),d=await A(),f=Object.entries(k.collections).flatMap(([o,h])=>h.files.flatMap(p=>h.languages.map(G=>[o,G,p]))),b=f.map(([o,h,p])=>E(o,h,p)),y=await Promise.all(b.map(o=>Q(n,d,o).then(async([h,p])=>[h!==void 0?(await h.blob()).size:-1,p])));i(y.map(([o,h],p)=>[f[p],o,h]).filter(([,o])=>o!==-1)),new Set(await V()).difference(new Set(b)).forEach(o=>{console.debug(`Deleted ${o} from cache`),n.delete(o),T(d,o)}),d.close(),t===null&&y.some(([o,h])=>o===-1||!h)&&J()}},R=async()=>{g.current&&(g.current.terminate(),g.current=null),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(n=>n.unregister());const t=[];if("indexedDB"in window&&"databases"in window.indexedDB&&t.push(Y().then(()=>C())),"caches"in window){const n=await B();t.push(n.keys().then(d=>Promise.all(d.map(f=>n.delete(f)))))}Promise.all(t).then(()=>{console.log("Cache cleared")}).catch(n=>{console.log("Error clearing cache"),console.error(n)})},$=async t=>{if("caches"in window&&"indexedDB"in window&&"databases"in window.indexedDB){const n=await B(),d=await A();await Promise.all(k.collections[t].languages.flatMap(f=>k.collections[t].files.flatMap(b=>{const y=E(t,f,b);return[T(d,y),n.delete(y)]}))),d.close(),C()}};r.useEffect(()=>{x(async()=>{await Promise.all([S(),C()])})},[]),r.useEffect(()=>{a&&(S(),C())},[a]);const U=async()=>{const t=await X(Object.keys(k.collections));c({message:s("cache.cacheAllModal.message",v(t)),buttons:[{message:s("cache.cacheAllModal.buttons.yes"),callback:N},{message:s("cache.cacheAllModal.buttons.no"),callback:()=>P(!1),autoFocus:!0}],cancelCallback:()=>P(!1)})},J=()=>{c({message:s("cache.cacheAllFailedModal.message"),buttons:[{message:s("cache.cacheAllFailedModal.buttons.ok"),autoFocus:!0}]})},q=async()=>{c({message:s("cache.clearCacheModal.message"),buttons:[{message:s("cache.clearCacheModal.buttons.yes"),callback:R},{message:s("cache.clearCacheModal.buttons.no"),autoFocus:!0}]})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cache cache-button-group item-group",children:[e.jsx("button",{onClick:U,disabled:M!==!1,children:s("cacheAll")}),e.jsx("button",{onClick:q,children:s("clearCache")})]}),e.jsx("div",{className:"cache cache-results app-window",children:!l&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{cacheStorageEnabled:u,cachedFileInfo:w}),M?e.jsx(se,{loadedBytes:I,totalBytes:L,progress:z}):e.jsx(ae,{cachedFileInfo:w,cacheCollections:N,clearCachedFile:$})]})})]})}export{re as default};
